<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web3 Emoji Game - ‡∏£‡∏±‡∏ö tBNB</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Fredoka', sans-serif; }
    
    .coin-float {
      position: fixed;
      font-weight: bold;
      font-size: 1.5rem;
      pointer-events: none;
      z-index: 1000;
      animation: floatUp 1.2s ease-out forwards;
    }
    
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      50% { opacity: 1; transform: translateY(-30px) scale(1.2); }
      100% { opacity: 0; transform: translateY(-80px) scale(0.8); }
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
      50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-10px); }
      40% { transform: translateX(10px); }
      60% { transform: translateX(-10px); }
      80% { transform: translateX(10px); }
    }
    
    .item-card {
      animation: bounce-in 0.4s ease-out forwards;
      transition: all 0.2s ease;
    }
    
    .item-card:hover {
      transform: scale(1.05);
    }
    
    .item-card:active {
      transform: scale(0.95);
    }
    
    .shake { animation: shake 0.5s ease; }
    .pulse-glow { animation: pulse-glow 2s infinite; }
    
    .gradient-text {
      background: linear-gradient(135deg, #f472b6, #a855f7, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .timer-bar {
      transition: width 0.1s linear;
    }
    
    .correct-flash {
      animation: correct-pulse 0.5s ease;
    }
    
    @keyframes correct-pulse {
      0% { background-color: rgba(34, 197, 94, 0.3); }
      100% { background-color: transparent; }
    }
    
    .wrong-flash {
      animation: wrong-pulse 0.5s ease;
    }
    
    @keyframes wrong-pulse {
      0% { background-color: rgba(239, 68, 68, 0.3); }
      100% { background-color: transparent; }
    }
  </style>
 </head>
 <body class="h-full overflow-auto bg-gradient-to-br from-purple-900 via-indigo-900 to-pink-900">
  <div class="min-h-full w-full">
   <!-- Header -->
   <header class="p-4">
    <div class="glass-card rounded-2xl p-4">
     <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <h1 class="text-2xl md:text-3xl font-bold gradient-text">üéÆ Web3 Emoji Quest</h1>
      <div class="flex flex-wrap justify-center gap-3 items-center">
       <div class="glass-card px-4 py-2 rounded-xl flex items-center gap-2">
        <span class="text-2xl">üí∞</span> <span id="coins" class="text-white font-bold text-lg">0</span>
       </div>
       <div class="glass-card px-4 py-2 rounded-xl flex items-center gap-2">
        <span class="text-2xl">‚≠ê</span> <span id="score" class="text-white font-bold text-lg">0</span>
       </div>
       <div class="glass-card px-4 py-2 rounded-xl flex items-center gap-2">
        <span id="lives-display" class="text-2xl">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
       </div>
       <div class="glass-card px-4 py-2 rounded-xl flex items-center gap-2">
        <span class="text-2xl">üíµ</span> <span id="wallet-balance" class="text-white font-bold text-lg">0</span> <span class="text-white/60 text-sm">tBNB</span>
       </div>
       <button id="wallet-btn" onclick="connectWallet()" class="bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white px-5 py-2 rounded-xl font-bold flex items-center gap-2 transition-all hover:scale-105 active:scale-95">
        <span>ü¶ä</span> <span id="wallet-text">Connect Wallet</span>
       </button>
      </div>
     </div>
    </div>
   </header>

   <!-- Treasury Info -->
   <div class="max-w-2xl mx-auto px-6 mb-4">
    <div class="bg-gradient-to-r from-yellow-600 to-orange-600 rounded-2xl p-3 text-white text-center">
     <p class="text-sm">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏•‡∏≤‡∏á: <span class="font-mono">0x4338E2...a7e2</span> (‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô)</p>
    </div>
   </div>

   <!-- Main Game Area -->
   <main class="p-6">
    <div class="max-w-2xl mx-auto">
     <!-- Timer Bar -->
     <div id="timer-container" class="mb-6 hidden">
      <div class="glass-card rounded-full p-1">
       <div id="timer-bar" class="timer-bar h-3 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full" style="width: 100%"></div>
      </div>
      <p class="text-center text-white/70 mt-2 text-sm">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ <span id="time-left">5</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
     </div>

     <!-- Request Display -->
     <div id="request-card" class="glass-card rounded-3xl p-8 mb-6 text-center pulse-glow">
      <p id="request" class="text-2xl md:text-3xl text-white font-medium">üéØ ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô!</p>
      <p id="round-info" class="text-white/60 mt-3 hidden">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="current-round">0</span> / <span id="max-rounds">10</span></p>
     </div>

     <!-- Start Button -->
     <div id="start-container" class="text-center mb-8">
      <button id="start-btn" onclick="startGame()" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-10 py-4 rounded-2xl font-bold text-xl transition-all hover:scale-105 active:scale-95 shadow-lg shadow-green-500/30">
       üéÆ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
      </button>
     </div>

     <!-- Items Grid -->
     <div id="items" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

     <!-- Game Over Modal -->
     <div id="game-over-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
      <div class="glass-card rounded-3xl p-8 max-w-md w-full text-center">
       <h2 class="text-4xl mb-4">üèÜ</h2>
       <h3 id="game-over-title" class="text-2xl font-bold text-white mb-4">‡∏à‡∏ö‡πÄ‡∏Å‡∏°!</h3>
       <div class="space-y-3 mb-6">
        <p class="text-white/80">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: <span id="final-score" class="text-yellow-400 font-bold text-xl">0</span> ‚≠ê</p>
        <p class="text-white/80">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: <span id="final-coins" class="text-yellow-400 font-bold text-xl">0</span> üí∞</p>
        <p class="text-white/80">‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: <span id="reward-amount" class="text-green-400 font-bold text-xl">0</span> tBNB</p>
       </div>
       <div class="flex flex-col gap-3">
        <button onclick="receiveReward()" id="receive-btn" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white px-6 py-3 rounded-xl font-bold transition-all hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
         üéÅ ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏õ‡πá‡∏ô tBNB
        </button>
        <button onclick="restartGame()" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-6 py-3 rounded-xl font-bold transition-all hover:scale-105">
         üîÑ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        </button>
       </div>
      </div>
     </div>

     <!-- Loading Modal -->
     <div id="loading-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
      <div class="glass-card rounded-3xl p-8 max-w-md w-full text-center">
       <div class="text-5xl mb-4 animate-spin">‚è≥</div>
       <h3 class="text-xl font-bold text-white mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
       <p id="loading-message" class="text-white/80">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
      </div>
     </div>

     <!-- Toast Container -->
     <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    </div>
   </main>
  </div>

  <script>
    // ===== CONFIG =====
    const treasuryAddress = "0x4338E2948148626a0dc49932BD1133f3Fac9a7e2"; // ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
    const exchangeRate = 0.0001; // 1 coin ‡πÉ‡∏ô‡πÄ‡∏Å‡∏° = 0.0001 tBNB

    // ===== EMOJI DATA =====
    const emojiCategories = [
      { name: "‡∏ú‡∏•‡πÑ‡∏°‡πâ", emojis: ["üçé", "üçä", "üçã", "üçá", "üçì", "üçë", "üçí", "ü•ù", "üçå", "üçâ"] },
      { name: "‡∏™‡∏±‡∏ï‡∏ß‡πå", emojis: ["üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üê®", "ü¶Å"] },
      { name: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", emojis: ["üçï", "üçî", "üåÆ", "üçú", "üç£", "üç©", "üç™", "üéÇ", "üç¶", "üßÅ"] },
      { name: "‡∏Å‡∏µ‡∏¨‡∏≤", emojis: ["‚öΩ", "üèÄ", "üèà", "‚öæ", "üéæ", "üèê", "üé±", "üèì", "üè∏", "ü•ä"] }
    ];

    // ===== GAME STATE =====
    let provider, signer, user;
    let coins = 0, score = 0, answer = "", round = 0, maxRound = 10;
    let lives = 3, timeLeft = 5, timerInterval = null;
    let gameActive = false, totalCoinsEarned = 0;

    // ===== TOAST SYSTEM =====
    function showToast(message, type = "info") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      
      const colors = {
        success: "from-green-500 to-emerald-500",
        error: "from-red-500 to-rose-500",
        info: "from-blue-500 to-indigo-500",
        warning: "from-yellow-500 to-orange-500"
      };
      
      toast.className = `bg-gradient-to-r ${colors[type]} text-white px-6 py-3 rounded-xl font-medium shadow-lg transform transition-all duration-300 translate-x-full`;
      toast.innerHTML = message;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove("translate-x-full");
      }, 10);
      
      setTimeout(() => {
        toast.classList.add("translate-x-full", "opacity-0");
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ===== LOADING MODAL =====
    function showLoading(message = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...") {
      document.getElementById("loading-message").innerText = message;
      document.getElementById("loading-modal").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loading-modal").classList.add("hidden");
    }

    // ===== WEB3 FUNCTIONS =====
    async function connectWallet() {
      if (!window.ethereum) {
        showToast("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á MetaMask ‡∏Å‡πà‡∏≠‡∏ô", "error");
        window.open("https://metamask.io/download/", "_blank");
        return;
      }

      try {
        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts"
        });

        user = accounts[0];
        await switchToBSC();

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();

        document.getElementById("wallet-text").innerText = user.slice(0, 6) + "..." + user.slice(-4);
        showToast("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "success");
        
        await getWalletBalance();
        await checkTreasuryBalance();

      } catch (err) {
        console.error(err);
        showToast("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
      }
    }

    async function switchToBSC() {
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: "0x61" }] // BSC Testnet
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: "0x61",
                chainName: "BNB Testnet",
                nativeCurrency: { name: "tBNB", symbol: "tBNB", decimals: 18 },
                rpcUrls: ["https://bsc-testnet.publicnode.com"],
                blockExplorerUrls: ["https://testnet.bscscan.com"]
              }]
            });
          } catch (addError) {
            console.error("Error adding network:", addError);
          }
        }
      }
    }

    async function getWalletBalance() {
      if (!provider || !user) return;
      try {
        const balance = await provider.getBalance(user);
        document.getElementById("wallet-balance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
      } catch (err) {
        console.error("Error getting wallet balance:", err);
      }
    }

    async function checkTreasuryBalance() {
      if (!provider) {
        provider = new ethers.providers.JsonRpcProvider('https://bsc-testnet.publicnode.com');
      }
      try {
        const balance = await provider.getBalance(treasuryAddress);
        return parseFloat(ethers.utils.formatEther(balance));
      } catch (err) {
        console.error("Error checking treasury:", err);
        return 0;
      }
    }

    // ===== RECEIVE REWARD =====
    async function receiveReward() {
      if (!user) {
        showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet ‡∏Å‡πà‡∏≠‡∏ô", "warning");
        return;
      }

      if (totalCoinsEarned <= 0) {
        showToast("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö", "warning");
        return;
      }

      const rewardAmount = totalCoinsEarned * exchangeRate;
      const treasuryBal = await checkTreasuryBalance();
      
      if (treasuryBal < rewardAmount) {
        showToast("‚ùå ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin", "error");
        return;
      }

      const receiveBtn = document.getElementById("receive-btn");
      receiveBtn.disabled = true;
      receiveBtn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...";

      showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô tBNB ‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏•‡∏≤‡∏á...");

      try {
        const amountInWei = ethers.utils.parseEther(rewardAmount.toFixed(6));

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á transaction ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏•‡∏≤‡∏á
        const transaction = {
          to: user,
          value: amountInWei,
          gasLimit: 21000,
        };

        showLoading("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô MetaMask...");
        
        // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ã‡πá‡∏ô transaction ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç
        const tx = await signer.sendTransaction(transaction);
        
        showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°...");
        await tx.wait();

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
        await getWalletBalance();
        
        showToast(`‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${rewardAmount.toFixed(6)} tBNB ‡πÅ‡∏•‡πâ‡∏ß!`, "success");
        
        receiveBtn.innerText = "‚úÖ ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
        receiveBtn.classList.add("opacity-50", "cursor-not-allowed");

        // ‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏π‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
        console.log("Transaction:", tx.hash);

      } catch (err) {
        console.error(err);
        if (err.code === 4001) {
          showToast("‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç", "error");
        } else if (err.message.includes("insufficient funds")) {
          showToast("‚ùå ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏°‡∏µ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÑ‡∏°‡πà‡∏û‡∏≠", "error");
        } else {
          showToast("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message.substring(0, 50), "error");
        }
        receiveBtn.disabled = false;
        receiveBtn.innerText = "üéÅ ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏õ‡πá‡∏ô tBNB";
      } finally {
        hideLoading();
      }
    }

    // ===== EFFECTS =====
    function showCoin(x, y, val) {
      const el = document.createElement("div");
      el.className = "coin-float";
      el.innerHTML = `+${val} üí∞`;
      el.style.left = x + "px";
      el.style.top = y + "px";
      el.style.color = "#fbbf24";
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1200);
    }

    function updateLivesDisplay() {
      const livesEl = document.getElementById("lives-display");
      livesEl.innerHTML = "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(3 - lives);
    }

    // ===== GAME LOGIC =====
    function startGame() {
      if (!user) {
        showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô", "warning");
        connectWallet();
        return;
      }

      coins = 0;
      score = 0;
      lives = 3;
      round = 0;
      totalCoinsEarned = 0;
      gameActive = true;

      document.getElementById("coins").innerText = "0";
      document.getElementById("score").innerText = "0";
      updateLivesDisplay();
      document.getElementById("start-container").classList.add("hidden");
      document.getElementById("timer-container").classList.remove("hidden");
      document.getElementById("round-info").classList.remove("hidden");
      document.getElementById("game-over-modal").classList.add("hidden");

      nextRound();
    }

    function nextRound() {
      if (!gameActive) return;
      
      round++;
      document.getElementById("current-round").innerText = round;

      if (round > maxRound || lives <= 0) {
        endGame();
        return;
      }

      const category = emojiCategories[Math.floor(Math.random() * emojiCategories.length)];
      const shuffled = [...category.emojis].sort(() => Math.random() - 0.5);
      const selected = shuffled.slice(0, 4);
      answer = selected[Math.floor(Math.random() * 4)];

      document.getElementById("request").innerHTML = `‡∏´‡∏≤ <span class="text-4xl">${answer}</span>`;
      
      renderItems(selected);
      startTimer();
    }

    function renderItems(emojis) {
      const container = document.getElementById("items");
      container.innerHTML = "";

      emojis.forEach((emoji, index) => {
        const btn = document.createElement("button");
        btn.className = "item-card glass-card p-6 rounded-2xl text-5xl md:text-6xl hover:bg-white/30 transition-all cursor-pointer";
        btn.style.animationDelay = `${index * 0.1}s`;
        btn.innerHTML = emoji;
        btn.onclick = (e) => checkAnswer(emoji, e);
        container.appendChild(btn);
      });
    }

    function startTimer() {
      timeLeft = 5;
      const maxTime = timeLeft;
      
      clearInterval(timerInterval);
      
      const timerBar = document.getElementById("timer-bar");
      const timeLeftEl = document.getElementById("time-left");
      
      timerInterval = setInterval(() => {
        timeLeft -= 0.1;
        const percentage = (timeLeft / maxTime) * 100;
        timerBar.style.width = percentage + "%";
        timeLeftEl.innerText = Math.ceil(timeLeft);
        
        if (percentage < 30) {
          timerBar.className = "timer-bar h-3 bg-gradient-to-r from-red-500 to-rose-500 rounded-full";
        } else if (percentage < 60) {
          timerBar.className = "timer-bar h-3 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full";
        } else {
          timerBar.className = "timer-bar h-3 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full";
        }
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          handleWrong();
        }
      }, 100);
    }

    function checkAnswer(selected, event) {
      if (!gameActive) return;
      
      clearInterval(timerInterval);

      if (selected === answer) {
        handleCorrect(event);
      } else {
        handleWrong();
      }
    }

    function handleCorrect(event) {
      const earnedCoins = 10;
      
      coins += earnedCoins;
      score += 100;
      totalCoinsEarned += earnedCoins;

      document.getElementById("coins").innerText = coins;
      document.getElementById("score").innerText = score;

      if (event) {
        const rect = event.target.getBoundingClientRect();
        showCoin(rect.left + rect.width / 2, rect.top, earnedCoins);
      }

      document.getElementById("request-card").classList.add("correct-flash");
      setTimeout(() => document.getElementById("request-card").classList.remove("correct-flash"), 500);

      setTimeout(nextRound, 500);
    }

    function handleWrong() {
      lives--;
      updateLivesDisplay();

      document.getElementById("request-card").classList.add("shake", "wrong-flash");
      setTimeout(() => {
        document.getElementById("request-card").classList.remove("shake", "wrong-flash");
      }, 500);

      if (lives <= 0) {
        setTimeout(endGame, 500);
      } else {
        setTimeout(nextRound, 500);
      }
    }

    function endGame() {
      gameActive = false;
      clearInterval(timerInterval);

      document.getElementById("items").innerHTML = "";
      document.getElementById("timer-container").classList.add("hidden");
      
      const rewardAmount = (totalCoinsEarned * exchangeRate).toFixed(6);
      
      document.getElementById("final-score").innerText = score;
      document.getElementById("final-coins").innerText = totalCoinsEarned;
      document.getElementById("reward-amount").innerText = rewardAmount;
      
      if (lives <= 0) {
        document.getElementById("game-over-title").innerText = "üíî ‡∏´‡∏°‡∏î‡∏´‡∏±‡∏ß‡πÉ‡∏à!";
      } else {
        document.getElementById("game-over-title").innerText = "üèÜ ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö!";
      }

      document.getElementById("game-over-modal").classList.remove("hidden");
    }

    function restartGame() {
      document.getElementById("game-over-modal").classList.add("hidden");
      document.getElementById("start-container").classList.remove("hidden");
      document.getElementById("round-info").classList.add("hidden");
      document.getElementById("request").innerHTML = "üéØ ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô!";
    }

    // ===== INIT =====
    window.onload = function() {
      if (window.ethereum) {
        window.ethereum.request({ method: 'eth_accounts' })
          .then(accounts => {
            if (accounts.length > 0) {
              user = accounts[0];
              connectWallet();
            }
          });
      }
    };

    // ===== META MASK EVENTS =====
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', function (accounts) {
        if (accounts.length === 0) {
          user = null;
          document.getElementById("wallet-text").innerText = "Connect Wallet";
          document.getElementById("wallet-balance").innerText = "0";
          showToast("üîå Disconnected", "info");
        } else {
          user = accounts[0];
          document.getElementById("wallet-text").innerText = user.slice(0, 6) + "..." + user.slice(-4);
          getWalletBalance();
        }
      });
    }
  </script>
 </body>
</html>